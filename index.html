<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>혼테일 타이머</title>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #f1f2f4;
      --panel-guest: #e9f3ff;
      --text: #111;
      --sub: #666;
      --box: #ffffff;
      --accent: #ffb347;
      --border: #d4d7dd;
      --remain-normal: #0d6efd;
      --remain-low: #d93025;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      padding: 14px;
      font-size: 13px;
    }
    h1 { margin: 0 0 10px 0; font-size: 16px; }
    .section {
      background: var(--panel);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .label {
      min-width: 90px;
      font-size: 12px;
      color: var(--sub);
    }
    .box {
      background: var(--box);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 4px 10px;
      min-width: 120px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    button {
      background: var(--accent);
      border: none;
      color: #222;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    button:active { transform: translateY(1px); }
    button.secondary {
      background: #d1d5db;
      color: #111;
    }
    .hotkey-input {
      width: 50px;
      background: #fff;
      border: 1px solid #d0d4db;
      border-radius: 4px;
      padding: 2px 4px;
      text-align: center;
      font-size: 11px;
    }
    #logbox {
      max-height: 140px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #d0d4db;
      border-radius: 6px;
      padding: 6px;
      font-size: 11px;
      line-height: 1.4;
    }
    .logline { margin-bottom: 3px; font-variant-numeric: tabular-nums; }

    /* 현재 시간 크게 */
    .center-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 14px;
    }
    #now-box {
      font-size: 34px;
      font-weight: 600;
      background: #fff;
      border: 1px solid #d4d7dd;
      border-radius: 8px;
      padding: 6px 14px;
      min-width: 220px;
      text-align: center;
    }

    /* 비숍/손님 공통 헤더 */
    .subheader-row {
      display: grid;
      grid-template-columns: 110px 110px 120px 120px 120px auto;
      gap: 8px;
      margin-bottom: 4px;
      align-items: center;
      color: #666;
      font-size: 11px;
    }
    .subheader-row span { text-align: center; }

    /* 비숍 행/손님 행 */
    .timer-row {
      display: grid;
      grid-template-columns: 110px 110px 120px 120px 120px auto;
      gap: 8px;
      margin-bottom: 5px;
      align-items: center;
    }

    /* 캐릭터ID 입력칸 */
    input.charname {
      width: 110px;
      background: #fff;
      border: 1px solid #d0d4db;
      border-radius: 4px;
      padding: 3px 5px;
      font-size: 12px;
      text-align: left;
    }

    /* 남은시간 박스 */
    .remain-box {
      background: #fff;
      border: 1px solid #d4d7dd;
      border-radius: 5px;
      padding: 4px 10px;
      width: 120px;
      text-align: center;
      font-variant-numeric: tabular-nums;
      color: var(--remain-normal);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>김1건희's 혼테일 타이머 
<br>단축키 자체설정가능ver.</h1>

  <!-- 현재 시간 -->
  <div class="center-row">
    <div id="now-box">--:--:--</div>
  </div>

  <!-- 혼테일 입장/종료 세로형 -->
  <div class="section">
    <div class="row">
      <div class="label">입장</div>
      <div id="enterTime" class="box">--:--:--</div>
      <button onclick="setEnter()">기록</button>
    </div>
    <div class="row">
      <div class="label">종료</div>
      <div id="endTime" class="box">--:--:--</div>
      <button onclick="setEnd()">기록</button>
    </div>
    <div class="row">
      <div class="label">소요</div>
      <div id="totalTime" class="box">--:--</div>
    </div>
  </div>

  <!-- 손님부활 및 비숍 리저 타이머 -->
  <div class="section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <h3 style="margin:0; font-size:13px;">손님부활 및 비숍 리저 타이머</h3>
      <div style="display:flex; align-items:center; gap:6px;">
        <button onclick="copyAllCooldowns()">기록 한줄 복사</button>
        <span style="font-size:11px; color:#777;">단축키</span>
        <input id="hk-copy" class="hotkey-input" value="F6" readonly>
        <span id="copyMsg" style="font-size:11px; color:#555;"></span>
      </div>
    </div>

    <!-- 헤더 -->
    <div class="subheader-row">
      <span style="text-align:left;">구분</span>
      <span style="text-align:left;">캐릭터ID</span>
      <span>리저 발동 시각</span>
      <span>리저 쿨해제 시각</span>
      <span>남은 시간</span>
      <span></span>
    </div>

    <!-- 비숍들 -->
    <div id="bishops"></div>

    <!-- 손님도 같은 그리드로 -->
    <div class="timer-row" id="guest-row" style="background: #d4e9ff; ">
      <div class="label" style="min-width:110px;">손님</div>
      <input class="charname" id="guest-name" placeholder="손님ID">
      <div id="guestDie" class="box" style="width:120px;">--:--:--</div>
      <div id="guestTown" class="box" style="width:120px;">--:--:--</div>
      <div id="guestRemain" class="remain-box" style="width:120px;">--:--</div>
      <div style="display:flex; gap:4px; align-items:center;">
        <button onclick="setGuestDie()">기록</button>
        <button class="secondary" onclick="resetGuest()">리셋</button>
        <span style="font-size:11px; color:#777;">단축키</span>
        <input id="hk-guest" class="hotkey-input" value="F5" readonly>
      </div>
    </div>
  </div>

  <!-- 로그 -->
  <div class="section">
    <h3 style="margin:4px 0 8px 0; font-size:13px;">로그</h3>
    <div id="logbox"></div>
  </div>

  <script>
    // ========= 유틸 =========
    function pad(n){ return n.toString().padStart(2,"0"); }
    function formatTime(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    function formatMMSS(ms){
      if (ms < 0) return "완료";
      const sec = Math.floor(ms/1000);
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${pad(m)}:${pad(s)}`;
    }

    const GUEST_ADD = 15 * 60 * 1000;
    const BISHOP_COOLDOWN = 30 * 60 * 1000;

    let enterAt = null;
    let endAt   = null;
    let guestDieAt = null;

    const logbox = document.getElementById("logbox");
    function addLog(msg){
      const line = document.createElement("div");
      line.className = "logline";
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logbox.prepend(line);
      if (logbox.childNodes.length > 150) {
        logbox.removeChild(logbox.lastChild);
      }
    }

    // ========= 단축키 저장 =========
    const defaultHotkeys = {
      bishop1: "F1",
      bishop2: "F2",
      bishop3: "F3",
      bishop4: "F4",
      guest:   "F5",
      copy:    "F6",
    };
    const HOTKEY_KEY = "ht_hotkeys_v6";
    let hotkeys = {...defaultHotkeys};

    function loadHotkeys(){
      const raw = localStorage.getItem(HOTKEY_KEY);
      if(!raw) return;
      try {
        const obj = JSON.parse(raw);
        hotkeys = {...hotkeys, ...obj};
      } catch(e){}
    }
    function saveHotkeys(){
      localStorage.setItem(HOTKEY_KEY, JSON.stringify(hotkeys));
    }
    loadHotkeys();

    function attachHotkeyInput(domId, hkKey){
      const el = document.getElementById(domId);
      if(!el) return;
      el.value = hotkeys[hkKey] || "";
      el.addEventListener("focus", ()=>{
        el.value = "";
      });
      el.addEventListener("blur", ()=>{
        if(!el.value) el.value = hotkeys[hkKey] || "";
      });
      el.addEventListener("keydown", (e)=>{
        e.preventDefault();
        const key = e.key;
        if(key){
          hotkeys[hkKey] = key;
          el.value = key;
          saveHotkeys();
          addLog(`단축키 변경: ${hkKey} → ${key}`);
        }
      });
    }

    // ========= 혼테일 입/종 =========
    function setEnter(){
      enterAt = new Date();
      document.getElementById("enterTime").textContent = formatTime(enterAt);
      updateTotal();
      addLog("입장 시간 기록");
    }
    function setEnd(){
      endAt = new Date();
      document.getElementById("endTime").textContent = formatTime(endAt);
      updateTotal();
      addLog("종료 시간 기록");
    }
    function updateTotal(){
      if(enterAt && endAt){
        const diff = endAt - enterAt;
        document.getElementById("totalTime").textContent = formatMMSS(diff);
      }
    }

    // ========= 손님 =========
    function setGuestDie(){
      guestDieAt = new Date();
      document.getElementById("guestDie").textContent = formatTime(guestDieAt);
      const townAt = new Date(guestDieAt.getTime() + GUEST_ADD);
      document.getElementById("guestTown").textContent = formatTime(townAt);
      addLog("손님 다이 기록");
    }
    function resetGuest(){
      guestDieAt = null;
      document.getElementById("guestDie").textContent = "--:--:--";
      document.getElementById("guestTown").textContent = "--:--:--";
      const gr = document.getElementById("guestRemain");
      gr.textContent = "--:--";
      gr.style.color = "var(--remain-normal)";
      addLog("손님 타이머 초기화");
    }

    // ========= 비숍 =========
    const bishops = [
      { id:1, name:"비숍1", charName:"", usedAt:null },
      { id:2, name:"비숍2", charName:"", usedAt:null },
      { id:3, name:"비숍3", charName:"", usedAt:null },
      { id:4, name:"알바/용병", charName:"", usedAt:null },
    ];
    const bishopsDiv = document.getElementById("bishops");
    bishops.forEach(b=>{
      const row = document.createElement("div");
      row.className = "timer-row";
      row.innerHTML = `
        <div class="label" style="min-width:110px;">${b.name}</div>
        <input class="charname" id="char-${b.id}" placeholder="캐릭터ID" value="">
        <div id="bz-used-${b.id}" class="box" style="width:120px;">--:--:--</div>
        <div id="bz-end-${b.id}" class="box" style="width:120px;">--:--:--</div>
        <div id="bz-remain-${b.id}" class="remain-box" style="width:120px;">--:--</div>
        <div style="display:flex; gap:4px; align-items:center;">
          <button onclick="setBishop(${b.id})">리저</button>
          <button class="secondary" onclick="resetBishop(${b.id})">리셋</button>
          <span style="font-size:11px; color:#777;">단축키</span>
          <input id="hk-bishop-${b.id}" class="hotkey-input" value="${hotkeys['bishop'+b.id] || ''}" readonly>
        </div>
      `;
      bishopsDiv.appendChild(row);

      // 캐릭터ID 변경
      row.querySelector(`#char-${b.id}`).addEventListener("input", (e)=>{
        b.charName = e.target.value;
      });

      // 단축키 input 활성
      attachHotkeyInput(`hk-bishop-${b.id}`, `bishop${b.id}`);
    });

    function setBishop(id){
      const b = bishops.find(x=>x.id===id);
      if(!b) return;
      const now = new Date();
      if (b.usedAt){
        const passed = now.getTime() - b.usedAt.getTime();
        if (passed < BISHOP_COOLDOWN){
          addLog(`${b.name} 아직 쿨 중`);
          return;
        }
      }
      b.usedAt = now;
      document.getElementById(`bz-used-${id}`).textContent = formatTime(now);
      const end = new Date(now.getTime() + BISHOP_COOLDOWN);
      document.getElementById(`bz-end-${id}`).textContent = formatTime(end);
      addLog(`${b.name} 리저 기록`);
    }

    function resetBishop(id){
      const b = bishops.find(x=>x.id===id);
      if(!b) return;
      b.usedAt = null;
      document.getElementById(`bz-used-${id}`).textContent = "--:--:--";
      document.getElementById(`bz-end-${id}`).textContent = "--:--:--";
      const rem = document.getElementById(`bz-remain-${id}`);
      rem.textContent = "--:--";
      rem.style.color = "var(--remain-normal)";
      addLog(`${b.name} 리셋`);
    }

    function copyAllCooldowns(){
      const parts = bishops.map(b=>{
        if(!b.usedAt) return `${b.charName || b.name} -`;
        const end = new Date(b.usedAt.getTime() + BISHOP_COOLDOWN);
        return `${b.charName || b.name} ${pad(end.getMinutes())}:${pad(end.getSeconds())}`;
      });
      let guestInfo = "";
      if(guestDieAt){
        const townAt = new Date(guestDieAt.getTime() + GUEST_ADD);
        guestInfo = ` / 손님마을 <${pad(townAt.getMinutes())}:${pad(townAt.getSeconds())}>`;
      }
      const line = parts.join(" / ") + guestInfo;
      navigator.clipboard.writeText(line).then(()=>{
        const cm = document.getElementById("copyMsg");
        cm.textContent = "복사됨: " + line;
        setTimeout(()=>{ cm.textContent = ""; }, 3000);
      });
      addLog("쿨 복사");
    }

    // 단축키 input 연결
    attachHotkeyInput("hk-guest", "guest");
    attachHotkeyInput("hk-copy", "copy");

    // ========= 주기적 갱신 =========
    setInterval(()=>{
      const now = new Date();
      document.getElementById("now-box").textContent = formatTime(now);

      // 손님 남은 시간
      if(guestDieAt){
        const remainMs = guestDieAt.getTime() + GUEST_ADD - now.getTime();
        const gr = document.getElementById("guestRemain");
        gr.textContent = formatMMSS(remainMs);
        if (remainMs > 0 && remainMs <= 60000) {
          gr.style.color = "var(--remain-low)";
        } else {
          gr.style.color = "var(--remain-normal)";
        }
      }

      // 비숍 남은 시간
      bishops.forEach(b=>{
        const el = document.getElementById(`bz-remain-${b.id}`);
        if(!b.usedAt){
          el.textContent = "--:--";
          el.style.color = "var(--remain-normal)";
          return;
        }
        const left = b.usedAt.getTime() + BISHOP_COOLDOWN - now.getTime();
        el.textContent = formatMMSS(left);
        if (left > 0 && left <= 60000){
          el.style.color = "var(--remain-low)";
        } else {
          el.style.color = "var(--remain-normal)";
        }
      });
    }, 500);

    // ========= 전역 키보드 =========
    document.addEventListener("keydown", (e)=>{
      if (e.target.tagName === "INPUT") return;
      const k = e.key;
      if (k === (hotkeys.guest   || "F5")) { setGuestDie(); return; }
      if (k === (hotkeys.copy    || "F6")) { copyAllCooldowns(); return; }
      if (k === (hotkeys.bishop1 || "F1")) { setBishop(1); return; }
      if (k === (hotkeys.bishop2 || "F2")) { setBishop(2); return; }
      if (k === (hotkeys.bishop3 || "F3")) { setBishop(3); return; }
      if (k === (hotkeys.bishop4 || "F4")) { setBishop(4); return; }
    });
  </script>
</body>
</html>